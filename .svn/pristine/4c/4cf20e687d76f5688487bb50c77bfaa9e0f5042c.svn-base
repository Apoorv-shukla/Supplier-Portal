<?php if(!defined('BASEPATH')) exit('No direct script access allowed');

require APPPATH . '/libraries/BaseController.php';
/**
 * Class : Login (LoginController)
 * Login class to control to authenticate user credentials and starts user's session.
 * @author : Kishor Mali
 * @version : 1.1
 * @since : 15 November 2016
 */
class Task extends BaseController
{
    /**
     * This is default constructor of the class
     */
    public function __construct()
    {
        parent::__construct();
        $this->load->helper('cias_helper');
        $this->load->library('form_validation');
    }
    
    /**
     * Index Page for this controller.
     */
    public function index()
    {
       $this->load->view('task_detail');
        //$data['page_title'] = 'Task Detail Page';
        // redirect('task_detail')
        // $this->loadViews('task_detail', $data);
    }

   public function paymentDetail() {
        $task_id = $this->uri->segment(3);
        $salesforce_data= $this->session->userdata();
        $url = $salesforce_data['instance_url']."/services/data/v43.0/query/?q=select id,name,GrandTotal__c,Amount__c,Status__c from PO_Payment__c where PurchaseOrder__c='".$task_id."' order by createdDate desc limit 1";
        $payment_data = sendGetRequest($url, $salesforce_data['access_token']);
          
        if(!empty($payment_data)){
            echo json_encode(["st"=>1,"payment_data"=>$payment_data]);

        } else { 
            echo json_encode(["st"=>0]);
        }
    }

    public function submitTaskDeliverable() {
        $salesforce_data= $this->session->userdata();
        $url = $salesforce_data['instance_url']."/services/data/v43.0/query/?q=select id,(select id,TASKRAY__Completed__c,name from TASKRAY__TaskRay_Checklist_Items__r) from TASKRAY__Project_Task__c where Purchase_Order__r.Supplier_Contact__c='".$salesforce_data['contact_id']."'";
        $submitTaskDeliverable = sendGetRequest($url, $salesforce_data['access_token']);
        if(!empty($submitTaskDeliverable)){
            echo json_encode(["st"=>1,"submitTaskDeliverable"=>$submitTaskDeliverable]);

        } else { 
            echo json_encode(["st"=>0]);
        }
    }

    
    public function updateSubmitTaskDeliverable() {

        $checkbox_id = $this->security->xss_clean($_REQUEST['check_id']);
        $check_id =explode(",", $checkbox_id);
       

         foreach ($check_id as $key => $value) {
            $data_id[] =array(
                "method" => "PATCH", 
                "url" => "v34.0/sobjects/TASKRAY__trChecklistItem__c/".$value,
                "richInput" => ["TASKRAY__Completed__c" => "true"]
            );   
        }
        // $data =json_encode($data_id);
        // echo '<pre>';print_r($data);die;

        $finalPostData = ["batchRequests" => $data_id];
        $salesforce_data= $this->session->userdata();
        $url = $salesforce_data['instance_url']."/services/data/v41.0/composite/batch";
        
        $submitTaskDeliverable = sendPostRequest($url, $finalPostData , $salesforce_data['access_token']);

        echo "<pre>";print_r($submitTaskDeliverable);die;
        if(!empty($submitTaskDeliverable)){
            echo json_encode(["st"=>1,"submitTaskDeliverable"=>$submitTaskDeliverable]);

        } else { 
            echo json_encode(["st"=>0]);
        }
    }



    public function submitTaskStatus() {

        $task_id = $this->security->xss_clean($_REQUEST['task_id']);
        $data =  ["type"=>"submit", "tasks"=>$task_id];
        $salesforce_data= $this->session->userdata();
        $url = $salesforce_data['instance_url']."/services/apexrest/TaskStatusUpdate";
        $submitTaskStatus = sendPostRequest($url, $data, $salesforce_data['access_token']);
        $result = json_decode($submitTaskStatus);
        
        if(!empty($submitTaskStatus)){
            echo json_encode(["st"=>1,"submitTaskStatus"=>$result->response->Updated_Tasks_List[0]->PO_Status__c]);

        } else { 
            echo json_encode(["st"=>0]);
        }
    }



    public function acceptTaskStatus() {

        $task_id = $this->security->xss_clean($_REQUEST['task_id']);
        $data =  ["type"=>"accept", "tasks"=>$task_id];
        $salesforce_data= $this->session->userdata();
        $url = $salesforce_data['instance_url']."/services/apexrest/TaskStatusUpdate";
        $acceptTaskStatus = sendPostRequest($url, $data, $salesforce_data['access_token']);
        $result = json_decode($acceptTaskStatus);
        if(!empty($result)){
            echo json_encode(["st"=>1,"acceptTaskStatus"=>$result->response->Updated_Tasks_List[0]->PO_Status__c]);

        } else { 
            echo json_encode(["st"=>0]);
        }
    }


    public function rejectTaskStatus() {

        $task_id = $this->security->xss_clean($_REQUEST['task_id']);
        $data =  ["type"=>"reject", "tasks"=>$task_id];
        $salesforce_data= $this->session->userdata();
        $url = $salesforce_data['instance_url']."/services/apexrest/TaskStatusUpdate";
        $rejectTaskStatus = sendPostRequest($url, $data, $salesforce_data['access_token']);
        $result = json_decode($rejectTaskStatus);
        if(!empty($result)){
            echo json_encode(["st"=>1,"rejectTaskStatus"=>$result->response->Updated_Tasks_List[0]->PO_Status__c]);

        } else { 
            echo json_encode(["st"=>0]);
        }
    }

}

